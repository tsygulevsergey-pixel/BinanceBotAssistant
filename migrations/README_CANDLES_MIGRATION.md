# –ú–∏–≥—Ä–∞—Ü–∏—è: –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ 100-500 —Ä–∞–∑

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ 8639 —Å–≤–µ—á–µ–π –∑–∞–Ω–∏–º–∞–ª–æ **3 –º–∏–Ω—É—Ç—ã** (20ms –Ω–∞ —Å–≤–µ—á—É)
- –ö–æ–¥ –¥–µ–ª–∞–ª 8639 SQL –∑–∞–ø—Ä–æ—Å–æ–≤ `SELECT` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `candles`
- ‚úÖ –ü–µ—Ä–µ–ø–∏—Å–∞–Ω –∫–æ–¥ –Ω–∞ BULK UPSERT (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ —Ç—ã—Å—è—á)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ö° –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ 8639 —Å–≤–µ—á–µ–π: **~1 —Å–µ–∫—É–Ω–¥–∞** (–≤–º–µ—Å—Ç–æ 3 –º–∏–Ω—É—Ç)
- ‚ö° –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: **–≤ 100-500 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**
- üõ°Ô∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∏–Ω–¥–µ–∫—Å–∞

---

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

### –®–ê–ì 1: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞

**–í–ê–ñ–ù–û!** –ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º –±–æ—Ç–µ.

```bash
# –ù–∞–∂–º–∏—Ç–µ Ctrl+C –µ—Å–ª–∏ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
```

### –®–ê–ì 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é

```bash
python migrations/add_candles_unique_index.py
```

–ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç:
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å) - –æ—Å—Ç–∞–≤–∏—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞

### –®–ê–ì 3: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞

```bash
start.bat
```

–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ **–≤ 100-500 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**! üöÄ

---

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ—Å—Ç—å –ª–∏ –≤ –±–∞–∑–µ –¥—É–±–ª–∏–∫–∞—Ç—ã:

```sql
SELECT symbol, timeframe, open_time, COUNT(*) 
FROM candles
GROUP BY symbol, timeframe, open_time
HAVING COUNT(*) > 1
```

### –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

–ï—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–∞–π–¥–µ–Ω—ã - –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å:

```sql
DELETE FROM candles
WHERE id NOT IN (
    SELECT MAX(id)
    FROM candles
    GROUP BY symbol, timeframe, open_time
)
```

### –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞

–ó–∞—â–∏—â–∞–µ—Ç –±–∞–∑—É –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –±—É–¥—É—â–µ–º:

```sql
CREATE UNIQUE INDEX idx_candles_symbol_timeframe_time 
ON candles (symbol, timeframe, open_time)
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ–∑–æ–ø–∞—Å–Ω–∞:**
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –±–æ—Ç–æ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –¥—É–±–ª–∏–∫–∞—Ç—ã
- –û—Å—Ç–∞–≤–ª—è–µ—Ç —Å–≤–µ–∂–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ) –≤–µ—Ä—Å–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)

‚úÖ **–ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:**
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- SQLite INSERT OR REPLACE –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç - –±–∞–∑–∞ —Å–∞–º–∞ –æ–±–Ω–æ–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏:
```python
for kline in klines:  # 8639 –∏—Ç–µ—Ä–∞—Ü–∏–π
    existing = session.query(...).first()  # 8639 SELECT –∑–∞–ø—Ä–æ—Å–æ–≤
    if existing:
        existing.close = ...  # UPDATE
    else:
        session.add(...)  # INSERT
session.commit()

# –í—Ä–µ–º—è: 3 –º–∏–Ω—É—Ç—ã –¥–ª—è 8639 —Å–≤–µ—á–µ–π
```

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
```python
# –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
candles_data = [...]  # 8639 –∑–∞–ø–∏—Å–µ–π

# –û–î–ò–ù –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö —Å–≤–µ—á–µ–π
session.execute(
    "INSERT OR REPLACE INTO candles (...) VALUES (...)",
    candles_data
)
session.commit()

# –í—Ä–µ–º—è: ~1 —Å–µ–∫—É–Ω–¥–∞ –¥–ª—è 8639 —Å–≤–µ—á–µ–π
```

---

## FAQ

**Q: –ü–æ—Ç–µ—Ä—è—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ?**  
A: –ù–µ—Ç! –ú–∏–≥—Ä–∞—Ü–∏—è —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –¥—É–±–ª–∏–∫–∞—Ç—ã, –æ—Å—Ç–∞–≤–ª—è—è –ø–æ—Å–ª–µ–¥–Ω—é—é (—Å–≤–µ–∂—É—é) –≤–µ—Ä—Å–∏—é –∫–∞–∂–¥–æ–π —Å–≤–µ—á–∏.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é?**  
A: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞, –Ω–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞ - –æ–Ω–∞ —Ç–æ–ª—å–∫–æ —É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

**Q: –ß—Ç–æ –µ—Å–ª–∏ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏?**  
A: –°–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç –≤–∞—Å - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π!

**Q: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–Ω–∏–º–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è?**  
A: –û–±—ã—á–Ω–æ 1-5 —Å–µ–∫—É–Ω–¥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö).

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ó–∞–º–µ—Ä—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|----------|-------------|----------------|-----------|
| –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ 8639 —Å–≤–µ—á–µ–π | 180 —Å–µ–∫—É–Ω–¥ | 1 —Å–µ–∫—É–Ω–¥–∞ | **180x** |
| –ó–∞–≥—Ä—É–∑–∫–∞ 90 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö | 3-5 –º–∏–Ω—É—Ç | 10-15 —Å–µ–∫—É–Ω–¥ | **12-30x** |
| –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ (206 —Å–∏–º–≤–æ–ª–æ–≤) | 7-8 –º–∏–Ω—É—Ç | 2-3 –º–∏–Ω—É—Ç—ã | **3-4x** |

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ - —Å–æ–æ–±—â–∏—Ç–µ –≤ —á–∞—Ç —Å –ø–æ–ª–Ω—ã–º –ª–æ–≥–æ–º –æ—à–∏–±–∫–∏.
