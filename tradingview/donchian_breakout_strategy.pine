// @version=5
// Donchian Breakout Strategy - адаптация стратегии бота для TradingView
strategy("Donchian Breakout (Bot Strategy)", overlay=true, 
         initial_capital=10000, default_qty_type=strategy.percent_of_equity, 
         default_qty_value=100, commission_type=strategy.commission.percent, 
         commission_value=0.04)

// ==================== ПАРАМЕТРЫ (можно менять) ====================

// Donchian Channel
donchian_length = input.int(20, "Donchian Length", minval=5, maxval=50)

// Фильтры (как в вашем боте)
min_adx = input.float(20, "Min ADX", minval=10, maxval=40)
min_atr_pct = input.float(0.3, "Min ATR %", minval=0.1, maxval=1.0, step=0.05)
min_bbw = input.float(0.02, "Min BB Width", minval=0.01, maxval=0.1, step=0.01)
min_score = input.float(2.0, "Min Score", minval=1.0, maxval=5.0, step=0.5)

// Risk Management
risk_reward_tp1 = input.float(1.0, "TP1 (R)", minval=0.5, maxval=3.0, step=0.1)
risk_reward_tp2 = input.float(2.0, "TP2 (R)", minval=1.0, maxval=5.0, step=0.5)

// ==================== ИНДИКАТОРЫ ====================

// Donchian Channel
upper_band = ta.highest(high, donchian_length)
lower_band = ta.lowest(low, donchian_length)
middle_band = (upper_band + lower_band) / 2

// ADX
[diPlus, diMinus, adx] = ta.dmi(14, 14)

// ATR
atr = ta.atr(14)
atr_pct = (atr / close) * 100

// Bollinger Bands Width
bb_basis = ta.sma(close, 20)
bb_dev = ta.stdev(close, 20)
bb_upper = bb_basis + 2 * bb_dev
bb_lower = bb_basis - 2 * bb_dev
bb_width = (bb_upper - bb_lower) / bb_basis

// EMA (для тренда)
ema_20 = ta.ema(close, 20)
ema_50 = ta.ema(close, 50)

// Volume
volume_ma = ta.sma(volume, 20)
volume_ratio = volume / volume_ma

// ==================== SCORING SYSTEM (упрощенный) ====================

calc_score(breakout_strength, vol_ratio, adx_val) =>
    score = 0.0
    
    // Base score от силы пробоя
    score := score + breakout_strength * 2
    
    // Volume bonus
    if vol_ratio > 1.5
        score := score + 1.0
    else if vol_ratio > 1.2
        score := score + 0.5
    
    // ADX bonus
    if adx_val > 30
        score := score + 1.0
    else if adx_val > 25
        score := score + 0.5
    
    score

// ==================== УСЛОВИЯ ВХОДА ====================

// LONG условия
long_breakout = close > upper_band[1] and close[1] <= upper_band[2]
long_breakout_strength = (close - upper_band[1]) / atr

// Фильтры LONG
long_adx_ok = adx > min_adx
long_atr_ok = atr_pct > min_atr_pct
long_bbw_ok = bb_width > min_bbw
long_trend_ok = close > ema_20 and ema_20 > ema_50  // Uptrend
long_volume_ok = volume_ratio > 1.1

// Считаем score для LONG
long_score = calc_score(long_breakout_strength, volume_ratio, adx)

// Финальное условие LONG
long_condition = long_breakout and long_adx_ok and long_atr_ok and 
                 long_bbw_ok and long_trend_ok and long_volume_ok and 
                 long_score >= min_score

// SHORT условия
short_breakout = close < lower_band[1] and close[1] >= lower_band[2]
short_breakout_strength = (lower_band[1] - close) / atr

// Фильтры SHORT
short_adx_ok = adx > min_adx
short_atr_ok = atr_pct > min_atr_pct
short_bbw_ok = bb_width > min_bbw
short_trend_ok = close < ema_20 and ema_20 < ema_50  // Downtrend
short_volume_ok = volume_ratio > 1.1

// Считаем score для SHORT
short_score = calc_score(short_breakout_strength, volume_ratio, adx)

// Финальное условие SHORT
short_condition = short_breakout and short_adx_ok and short_atr_ok and 
                  short_bbw_ok and short_trend_ok and short_volume_ok and 
                  short_score >= min_score

// ==================== УПРАВЛЕНИЕ ПОЗИЦИЯМИ ====================

// LONG Entry
if long_condition and strategy.position_size == 0
    entry_price = close
    stop_loss = lower_band  // SL на нижнюю границу Donchian
    risk = entry_price - stop_loss
    tp1_price = entry_price + risk * risk_reward_tp1
    tp2_price = entry_price + risk * risk_reward_tp2
    
    strategy.entry("Long", strategy.long, 
                   alert_message='{"action":"buy","score":' + str.tostring(long_score) + '}')
    strategy.exit("TP1", from_entry="Long", limit=tp1_price, stop=stop_loss, qty_percent=50)
    strategy.exit("TP2", from_entry="Long", limit=tp2_price, stop=stop_loss, qty_percent=50)

// SHORT Entry
if short_condition and strategy.position_size == 0
    entry_price = close
    stop_loss = upper_band  // SL на верхнюю границу Donchian
    risk = stop_loss - entry_price
    tp1_price = entry_price - risk * risk_reward_tp1
    tp2_price = entry_price - risk * risk_reward_tp2
    
    strategy.entry("Short", strategy.short,
                   alert_message='{"action":"sell","score":' + str.tostring(short_score) + '}')
    strategy.exit("TP1", from_entry="Short", limit=tp1_price, stop=stop_loss, qty_percent=50)
    strategy.exit("TP2", from_entry="Short", limit=tp2_price, stop=stop_loss, qty_percent=50)

// ==================== ВИЗУАЛИЗАЦИЯ ====================

// Donchian Channel
plot(upper_band, "Upper Band", color=color.green, linewidth=2)
plot(lower_band, "Lower Band", color=color.red, linewidth=2)
plot(middle_band, "Middle Band", color=color.gray, linewidth=1)

// EMA
plot(ema_20, "EMA 20", color=color.blue, linewidth=1)
plot(ema_50, "EMA 50", color=color.orange, linewidth=1)

// Background для фильтров
bgcolor(adx > min_adx ? color.new(color.green, 95) : na, title="ADX OK")
bgcolor(atr_pct > min_atr_pct ? color.new(color.blue, 95) : na, title="ATR OK")

// Метки сигналов с score
if long_condition
    label.new(bar_index, low, "LONG\n" + str.tostring(long_score, "#.#"), 
              style=label.style_label_up, color=color.green, textcolor=color.white)

if short_condition
    label.new(bar_index, high, "SHORT\n" + str.tostring(short_score, "#.#"), 
              style=label.style_label_down, color=color.red, textcolor=color.white)
