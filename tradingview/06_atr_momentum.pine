// @version=5
// Strategy #6: ATR Momentum
// Высокоимпульсные движения на основе ATR
strategy("06. ATR Momentum", overlay=true, 
         initial_capital=10000, default_qty_type=strategy.percent_of_equity, 
         default_qty_value=100, commission_type=strategy.commission.percent, 
         commission_value=0.04)

// Параметры
impulse_atr = input.float(1.4, "Impulse ATR", minval=0.5, maxval=3.0, step=0.1)
ema_fast = input.int(9, "EMA Fast", minval=5, maxval=20)
ema_slow = input.int(20, "EMA Slow", minval=10, maxval=50)
volume_threshold = input.float(1.5, "Volume Threshold", minval=1.0, maxval=3.0, step=0.1)

// Индикаторы
atr = ta.atr(14)
ema_9 = ta.ema(close, ema_fast)
ema_20 = ta.ema(close, ema_slow)

// Volume
volume_ma = ta.sma(volume, 20)
volume_ratio = volume / volume_ma

// Импульс (размер свечи)
candle_size = high - low
strong_impulse = candle_size > atr * impulse_atr

// Направление импульса
bullish_impulse = strong_impulse and close > open and close > ema_9
bearish_impulse = strong_impulse and close < open and close < ema_9

// Тренд
uptrend = ema_9 > ema_20
downtrend = ema_9 < ema_20

// Entry условия
long_condition = bullish_impulse and uptrend and volume_ratio > volume_threshold and strategy.position_size == 0
short_condition = bearish_impulse and downtrend and volume_ratio > volume_threshold and strategy.position_size == 0

// Position Management
if long_condition
    strategy.entry("Long", strategy.long)
    strategy.exit("Exit Long", from_entry="Long", stop=close - atr * 1.5, limit=close + atr * 2.0)

if short_condition
    strategy.entry("Short", strategy.short)
    strategy.exit("Exit Short", from_entry="Short", stop=close + atr * 1.5, limit=close - atr * 2.0)

// Visualization
plot(ema_9, "EMA 9", color=color.orange, linewidth=2)
plot(ema_20, "EMA 20", color=color.blue, linewidth=2)

bgcolor(uptrend ? color.new(color.green, 95) : downtrend ? color.new(color.red, 95) : na)
barcolor(strong_impulse ? color.new(color.yellow, 50) : na)

if long_condition
    label.new(bar_index, low, "IMPULSE ↑", style=label.style_label_up, color=color.green, textcolor=color.white)

if short_condition
    label.new(bar_index, high, "IMPULSE ↓", style=label.style_label_down, color=color.red, textcolor=color.white)
