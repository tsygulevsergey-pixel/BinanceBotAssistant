// @version=5
// Smart Money Liquidity Hunt Strategy
// Концепция: Ловим институциональные "охоты за ликвидностью" + reversal подтверждения
strategy("Smart Money Liquidity Hunt", overlay=true, 
         initial_capital=10000, default_qty_type=strategy.percent_of_equity, 
         default_qty_value=100, commission_type=strategy.commission.percent, 
         commission_value=0.04)

// ==================== ПАРАМЕТРЫ ====================

// Liquidity Hunt Detection
liquidity_lookback = input.int(20, "Liquidity Sweep Lookback", minval=10, maxval=50)
sweep_tolerance = input.float(0.15, "Sweep Tolerance %", minval=0.05, maxval=0.5, step=0.05)
min_wick_ratio = input.float(0.4, "Min Wick/Body Ratio", minval=0.2, maxval=0.8, step=0.1)

// Order Flow Confirmation
min_volume_spike = input.float(1.8, "Min Volume Spike", minval=1.2, maxval=3.0, step=0.1)
min_momentum_shift = input.float(0.5, "Min Momentum Shift", minval=0.3, maxval=1.5, step=0.1)

// Market Structure
structure_period = input.int(10, "Market Structure Period", minval=5, maxval=20)

// Session Filter (опционально)
use_session_filter = input.bool(true, "Use Session Filter")
london_open = input.session("0700-1100", "London Session (Prime Time)")

// Risk Management
atr_multiplier_sl = input.float(1.5, "ATR Multiplier for SL", minval=0.5, maxval=3.0, step=0.1)
risk_reward_tp1 = input.float(1.5, "TP1 (R)", minval=0.5, maxval=3.0, step=0.1)
risk_reward_tp2 = input.float(3.0, "TP2 (R)", minval=1.0, maxval=5.0, step=0.5)

// ==================== ИНДИКАТОРЫ ====================

// ATR для волатильности
atr = ta.atr(14)

// Volume анализ
volume_ma = ta.sma(volume, 20)
volume_spike = volume / volume_ma

// EMA для тренда
ema_fast = ta.ema(close, 9)
ema_slow = ta.ema(close, 21)
ema_filter = ta.ema(close, 50)

// RSI для momentum
rsi = ta.rsi(close, 14)
rsi_ma = ta.sma(rsi, 14)

// Momentum shift detection
momentum = close - close[3]
momentum_ma = ta.sma(momentum, 5)

// ==================== LIQUIDITY SWEEP DETECTION ====================

// Находим недавние high/low (потенциальные зоны ликвидности)
recent_high = ta.highest(high, liquidity_lookback)
recent_low = ta.lowest(low, liquidity_lookback)

// Предыдущие swing high/low (где розница ставит стопы)
swing_high = ta.pivothigh(high, structure_period, structure_period)
swing_low = ta.pivotlow(low, structure_period, structure_period)

// Liquidity Sweep LONG Setup (охота вниз, потом разворот вверх)
// 1. Цена пробила недавний low (sweep)
price_swept_low = low < recent_low[1] * (1 - sweep_tolerance/100)

// 2. Но закрылась обратно выше (reversal = ложный пробой)
swept_and_reversed_long = price_swept_low and close > recent_low[1]

// 3. Большой нижний wick (rejection)
lower_wick = close - low
body = math.abs(close - open)
wick_rejection_long = lower_wick > body * min_wick_ratio

// Liquidity Sweep SHORT Setup (охота вверх, потом разворот вниз)
price_swept_high = high > recent_high[1] * (1 + sweep_tolerance/100)
swept_and_reversed_short = price_swept_high and close < recent_high[1]

upper_wick = high - close
wick_rejection_short = upper_wick > body * min_wick_ratio

// ==================== ORDER FLOW CONFIRMATION ====================

// Volume Confirmation (умные деньги входят с объемом)
volume_confirmation = volume_spike > min_volume_spike

// Momentum Shift Detection
// LONG: momentum был негативным, стал позитивным
momentum_shift_long = momentum > 0 and momentum[1] <= 0 and 
                      momentum > momentum_ma * min_momentum_shift

// SHORT: momentum был позитивным, стал негативным  
momentum_shift_short = momentum < 0 and momentum[1] >= 0 and 
                       math.abs(momentum) > math.abs(momentum_ma) * min_momentum_shift

// RSI Divergence (опциональное подтверждение)
// LONG: Price делает lower low, но RSI делает higher low
rsi_bull_div = low < low[5] and rsi > rsi[5] and rsi < 40

// SHORT: Price делает higher high, но RSI делает lower high
rsi_bear_div = high > high[5] and rsi < rsi[5] and rsi > 60

// ==================== MARKET STRUCTURE ====================

// Определяем направление тренда через swing structure
is_uptrend = close > ema_filter and ema_fast > ema_slow
is_downtrend = close < ema_filter and ema_fast < ema_slow
is_ranging = not is_uptrend and not is_downtrend

// Лучшие сетапы - counter-trend в сильных трендах (reversal от extremes)
// или with-trend в ranging markets

// ==================== SESSION FILTER ====================

in_session = true
if use_session_filter
    in_session := na(time(timeframe.period, london_open)) ? false : true

// ==================== SCORING SYSTEM ====================

calc_long_score() =>
    score = 0.0
    
    // Base: Liquidity Sweep
    if swept_and_reversed_long
        score := score + 2.0
    
    // Wick Rejection
    if wick_rejection_long
        score := score + 1.0
    
    // Volume Spike
    if volume_confirmation
        score := score + 1.5
    
    // Momentum Shift
    if momentum_shift_long
        score := score + 1.5
    
    // RSI Divergence (bonus)
    if rsi_bull_div
        score := score + 1.0
    
    // Session bonus
    if in_session
        score := score + 0.5
    
    // Structure bonus (reversal в downtrend)
    if is_downtrend
        score := score + 1.0
    
    score

calc_short_score() =>
    score = 0.0
    
    if swept_and_reversed_short
        score := score + 2.0
    
    if wick_rejection_short
        score := score + 1.0
    
    if volume_confirmation
        score := score + 1.5
    
    if momentum_shift_short
        score := score + 1.5
    
    if rsi_bear_div
        score := score + 1.0
    
    if in_session
        score := score + 0.5
    
    if is_uptrend
        score := score + 1.0
    
    score

// ==================== ENTRY CONDITIONS ====================

// LONG Entry
long_liquidity_sweep = swept_and_reversed_long
long_confirmation = wick_rejection_long and volume_confirmation
long_momentum = momentum_shift_long or rsi_bull_div
long_score = calc_long_score()

long_condition = long_liquidity_sweep and long_confirmation and 
                 long_momentum and long_score >= 5.0 and 
                 strategy.position_size == 0

// SHORT Entry
short_liquidity_sweep = swept_and_reversed_short
short_confirmation = wick_rejection_short and volume_confirmation
short_momentum = momentum_shift_short or rsi_bear_div
short_score = calc_short_score()

short_condition = short_liquidity_sweep and short_confirmation and 
                  short_momentum and short_score >= 5.0 and 
                  strategy.position_size == 0

// ==================== POSITION MANAGEMENT ====================

// LONG Entry & Exits
if long_condition
    entry_price = close
    // SL ниже недавнего low с буфером ATR
    stop_loss = recent_low - atr * atr_multiplier_sl
    risk = entry_price - stop_loss
    tp1_price = entry_price + risk * risk_reward_tp1
    tp2_price = entry_price + risk * risk_reward_tp2
    
    strategy.entry("Long", strategy.long,
                   alert_message='{"action":"buy","type":"liquidity_hunt","score":' + 
                   str.tostring(long_score) + '}')
    strategy.exit("TP1", from_entry="Long", limit=tp1_price, stop=stop_loss, qty_percent=50)
    strategy.exit("TP2", from_entry="Long", limit=tp2_price, stop=stop_loss, qty_percent=50)

// SHORT Entry & Exits
if short_condition
    entry_price = close
    // SL выше недавнего high с буфером ATR
    stop_loss = recent_high + atr * atr_multiplier_sl
    risk = stop_loss - entry_price
    tp1_price = entry_price - risk * risk_reward_tp1
    tp2_price = entry_price - risk * risk_reward_tp2
    
    strategy.entry("Short", strategy.short,
                   alert_message='{"action":"sell","type":"liquidity_hunt","score":' + 
                   str.tostring(short_score) + '}')
    strategy.exit("TP1", from_entry="Short", limit=tp1_price, stop=stop_loss, qty_percent=50)
    strategy.exit("TP2", from_entry="Short", limit=tp2_price, stop=stop_loss, qty_percent=50)

// ==================== ВИЗУАЛИЗАЦИЯ ====================

// Recent High/Low зоны (где ликвидность)
plot(recent_high, "Liquidity High", color=color.new(color.red, 70), linewidth=1, style=plot.style_stepline)
plot(recent_low, "Liquidity Low", color=color.new(color.green, 70), linewidth=1, style=plot.style_stepline)

// EMA тренд фильтр
plot(ema_filter, "EMA 50", color=color.blue, linewidth=2)
plot(ema_fast, "EMA 9", color=color.orange, linewidth=1)
plot(ema_slow, "EMA 21", color=color.purple, linewidth=1)

// Background для session
bgcolor(in_session ? color.new(color.yellow, 95) : na, title="Prime Session")

// Sweep detection markers
plotshape(swept_and_reversed_long, "Sweep Low", shape.triangleup, 
          location.belowbar, color=color.green, size=size.small)
plotshape(swept_and_reversed_short, "Sweep High", shape.triangledown, 
          location.abovebar, color=color.red, size=size.small)

// Entry signals с score
if long_condition
    label.new(bar_index, low, "LONG\nScore: " + str.tostring(long_score, "#.#"), 
              style=label.style_label_up, color=color.new(color.green, 20), 
              textcolor=color.white, size=size.normal)

if short_condition
    label.new(bar_index, high, "SHORT\nScore: " + str.tostring(short_score, "#.#"), 
              style=label.style_label_down, color=color.new(color.red, 20), 
              textcolor=color.white, size=size.normal)

// Volume spike highlighting
barcolor(volume_spike > min_volume_spike ? color.new(color.yellow, 70) : na, title="Volume Spike")
