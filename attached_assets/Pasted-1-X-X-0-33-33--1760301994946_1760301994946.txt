1) «Касание зоны»: какая доля тени в зоне (X)?

Рекомендация: X = 0.33 (33% ширины зоны).

Диапазон для тонкой настройки: 0.30…0.50.

Если сделаешь выше 0.5 — потеряешь много валидных «колющих» ретестов; ниже 0.3 — начнёшь считать лишний шум.

Формализация:
касание засчитывается, если тело бара закрывается вне зоны, а длина тени, оказавшейся внутри зоны, ≥ X * zone_width.

2) Отбор зон по расстоянию K * ATR_1D

Рекомендация: K = 3.0 по умолчанию.

Диапазон: 2.5…4.0.

Для очень волатильных альтов можно стартовать с K = 3.5, для BTC/ETH — K = 3.0.

Смысл: оставить только «рабочие» зоны вокруг цены, не засоряя стек дальними уровнями.

3) Конфлюэнсы с (A)VWAP: как трактовать «вектор»?

Правильно понимать так (под «вектор совпадает» имелось в виду поведение как поддержки/сопротивления):

LONG у demand: (A)VWAP должен играть роль поддержки → допустимо, когда (A)VWAP ≤ price (линия не выше текущей цены). Цена «тестирует сверху/на» VWAP.

SHORT у supply: (A)VWAP — сопротивление → (A)VWAP ≥ price. Цена «тестирует снизу/на» VWAP.

Разрешай погрешность по близости:
abs(price - vwap) ≤ β * MTR_exec (рекомендую β = 1.0).
Опционально добавь слабый фильтр наклона: для LONG slope_vwap ≥ -ε, для SHORT slope_vwap ≤ +ε с ε небольшим (например, 0.0…0.05 * ATR/бар), чтобы не зарубать плоские участки.

4) Период MTR

Цель: базовые ТФ (H1/H4) — устойчивость; execution-ТФ (15m) — отзывчивость.
Рекомендация:

H4, H1: MTR_n = 50

15m: MTR_n = 30

1D (если используешь MTR на дневке): MTR_n = 50

Если хочешь унифицировать — можно поставить 50 везде, но 15m с 30 даёт чуть живее «близость к зоне» без скачков.

5) Обратная совместимость

Не переписывать “намертво”. Вынеси в конфиг флаг и параметры:

Флаг логики: action_price.version = "v1" | "v2" (по умолчанию "v2" — новая).

Все числовые пороги/коэффициенты — отдельными ключами.

В рантайме даёшь возможность выбрать v1/v2, чтобы:

Прогнать бэктест A/B на одном и том же периоде.

Плавно перевести прод на v2, если метрики ок.

6) «p30» в фильтрах волатильности/режима

Да, p30 — это 30-й перцентиль за скользящее окно.
Рекомендация окна: последние 90 календарных дней по соответствующему ТФ (у тебя как раз есть 90 дней истории).
Если где-то данных меньше — fallback на 60 дней.
Пример: ATR%_H1 < p30_H1 и BBW_H1 < p30_H1 вместе с ADX_H1 < 14 → «супер-пила», PA лучше пропустить.

7) Unit-тесты: куда класть?

С учётом твоей структуры проекта — логично так:

tests/
  features/
    action_price/
      test_zones.py
      test_patterns.py
      test_proximity.py
      test_risk_rr.py
      test_confluence_vwap.py
      test_scoring_v2.py


Если у тебя уже есть каталог tests/strategies/…, тогда:

tests/strategies/action_price/...


Главное — отдельный модуль (легче запускать из CI и видеть покрытие именно по стратегии).

Блок «значения по умолчанию» (готовые)

touch_shadow_ratio_in_zone (X) → 0.33

zones_max_distance_K_ATR1D → 3.0 (BTC/ETH), 3.5 (мелкие альты)

vwap_proximity_beta → 1.0 (|price - vwap| ≤ 1.0 * MTR_exec)

mtr_n: H4=50, H1=50, M15=30, D1=50

ema_strict → true (с «pullback-исключением» снижать скор, а не отклонять)

rr_min → 1.2

vwap_family_bonus_cap → 1.2 суммарно

zone_touch_gap_bars (анти-дребезг на H4) → 5

zones_top_per_side → 3 (3 demand + 3 supply в окне K*ATR1D)

overlap_ratio_inside_zone (для «паттерн внутри зоны») → 0.30