1) Базовые определения

Инициатор — свеча, телом пересекающая EMA200.

Подтверждение — следующая свеча закрывается за EMA200 в сторону сделки и не касается EMA200 ни телом, ни тенью.

Все “усилители/штрафы” работают через скоринг, а не жёсткие запреты.

2) Условия сигнала
Лонг (mirror для шорта ниже)

Обязательные:

Инициатор: body-cross↑ EMA200 (закрытие выше).

Подтверждение: close выше EMA200, без касания EMA200.

Скоринг (очки):
(рекомендуемая шкала; числа — по месту подтверждения)

Размер инициатора (|body| в ATR):
+2 если ≥ 1.10×ATR; +1 если 0.80–1.09×ATR.

Глубина подтверждения (|close−EMA200| в ATR):
+2 если ≥ 0.40×ATR; +1 если 0.35–0.39×ATR; −1 если < 0.30×ATR.

Положение закрытия подтверждения:
+1 если выше всей ленты EMA5/9/13/21; 0 если внутри ленты; −1 если ниже EMA21.

Наклон EMA200 в сторону входа (нормировать на ATR за N=10 баров):
+1 если |slope| ≥ 0.20×ATR (up); −1 если ≤ −0.20×ATR (down); 0 если плоская.

Состояние ленты EMA5/9/13/21:
+1 если бычий веер (5>9>13>21) и спред (EMA21−EMA5)/ATR ≥ 0.10; −1 если медвежий; 0 если сжата.

Запас до внешней ATR-полосы в сторону сделки:
+1 если ≥ 0.50×ATR; −1 если < 0.30×ATR.

“Липучка к EMA200” (касания EMA200 за 5 баров):
−1 если касаний ≥3 (режим рейнджа).

Цвет подтверждения:
+1 если тот же (зелёный для лонга); −1 если противоположный и глубина <0.30×ATR.

Break-and-Base над EMA200 (2–4 узких бара, удержание EMA13/21): +1.

Retest-tag (продолжение тренда) — если вход не первый кросс, а отбой от 21/200 при бычьей структуре: +1.

Хвост инициатора (нижняя тень/ATR) ≥ 0.25–0.35: +1 (отказ от продаж).

Интерпретация суммы:

Score ≥ 3 → режим standard (целим TP2).

Score = 1–2 → режим scalp/консервативный (только TP1, без усреднений).

Score ≤ 0 → пропуск.

Шорт

Полное зеркалирование:

Инициатор: body-cross↓ EMA200; подтверждение: close ниже, без касания.

В скоринге: веер медвежий, наклон 200-й вниз, запас до нижней ATR-полосы, верхние тени и т.д.

3) Точка входа / стоп / тейки / сопровождение

Вход: на закрытии подтверждающей свечи.
Если score 1–2 и рынок трендовый — допускается «retest-вход»: после микро-отката к EMA13/21 в сторону сделки появляется бар-отбой (закрытие снова в направленную сторону ниже/выше ленты) — вход по его закрытию.

Стоп-лосс (SL): за экстремум инициатора (+ буфер 0.05–0.10×ATR).
Лонг — под минимумом инициатора; шорт — над максимумом инициатора.

TP-логика (RR по стопу):
• TP1 = 1R; при достижении — перенос SL в безубыток (уровень входа).
• TP2 = 2R (для режима standard).
• Для scalp — фиксируем TP1, далее по ситуации (можно частично trail по EMA9/13).

4) Что писать в логи (минимум, чтобы я потом мог улучшать логику)
Метаданные

signal_id, timestamp_open (UTC), symbol, timeframe.

direction (long/short), pattern (body-cross / trend-retest), mode (standard / scalp / pass).

score_total и все компоненты скоров (см. список выше) отдельными полями.

Цена/уровни

entry_price, sl_price, tp1_price, tp2_price.

risk_R (в пунктах/USDT), spread_at_entry (если есть), slippage_entry.

EMA/ATR на инициаторе и на подтверждении (два набора)

ema5/9/13/21/200.

atr (значение), atr_upper_band, atr_lower_band (если рисуешь полосы).

slope_ema200_norm = (EMA200 − EMA200[10]) / ATR (на подтверждении).

ema_fan_state (bullish/bearish/flat), ema_fan_spread_norm = (EMA21−EMA5)/ATR.

Свечные метрики (инициатор и подтверждение отдельно)

open/high/low/close.

body_size_atr = |close−open|/ATR, upper_wick_atr, lower_wick_atr.

body_cross_type (up/down/none), confirm_depth_atr = |close−EMA200|/ATR.

confirm_color (green/red).

touch_ema200 (касание телом/тенью: yes/no).

close_vs_ema_fan (above_all / inside / below_all).

gap_to_outer_band_atr (в сторону сделки).

Контекст/структура

touches_ema200_last5 (сколько касаний за 5 баров до входа).

trend_tag (up/down/side) по наклону 200-й и вееру.

retest_tag (true/false).

break_and_base_tag (true/false).

swing_high_price/index, swing_low_price/index (последние свинги до входа) — хватит индекс бара и цена.

Результат и ход сделки

exit_reason (TP1_BE, TP2, SL, CANCEL_NO_CONFIRM, CANCEL_FILTER).

timestamp_exit, exit_price.

time_to_tp1_bars/mins, time_to_exit_bars/mins.

MFE/MAE в R (макс. благоприятное / неблагоприятное отклонение до выхода).

bars_in_trade (длительность).

(опционально) volume на инициаторе/подтверждении, atr_regime = ATR / medianATR(100).