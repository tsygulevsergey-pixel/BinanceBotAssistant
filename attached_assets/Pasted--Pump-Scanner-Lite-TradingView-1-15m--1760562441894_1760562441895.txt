ТЗ: Индикатор Pump Scanner (Lite) для TradingView
1) Цель

Найти на 15m графиках моменты, когда монета находится в «заряженном» состоянии (компрессия/подготовка) и выстрел вероятен, а также зафиксировать момент «пуска» импульса. Индикатор возвращает скоринг (оценку вероятности) и выдаёт алерты.

2) Платформа и ограничения

TradingView, Pine Script v5, overlay=true.

Без внешних API (OI/фандинг/книга заявок недоступны в Lite-версии).

Допустимый max_labels_count — экономно, не «засорять» график.

Работает на любом ТФ, но профиль по умолчанию — 15m.

3) Базовые расчёты (серии)

EMA200 (белая) и её наклон:

ema200 = ta.ema(close, emaLen200)

slope200 = (ema200 - ema200[1]) / atr(14) (нормировать на ATR).

Лента EMA 5/9/13/21 (цвета как в наших скринах: 5 — красная, 9 — оранжевая, 13 — жёлтая, 21 — зелёная).

ATR(14) и ATR-каналы: mid=ema(close,atrLenBase); upper=close + atrMult*atr, lower=close - atrMult*atr.

Bollinger Bands: bbBasis = ta.sma(close, bbLen), bbDev = ta.stdev(close, bbLen), bbUpper = bbBasis + bbMult*bbDev, bbLower = bbBasis - bbMult*bbDev, **BBWidth = (bbUpper-bbLower)/bbBasis`.

Keltner Channel: kcMid = ta.ema(close, kcLen), kcUpper = kcMid + kcMult*ta.atr(kcLen), kcLower = kcMid - kcMult*ta.atr(kcLen).

TTM-Squeeze (компрессия): squeezeOn = (bbUpper < kcUpper) and (bbLower > kcLower).
Альтернатива: bbWidth < sma(bbWidth, lookbackBW)*bwCoef для слабых активов.

Swing High/Low: параметр swingLen (по умолчанию 20).

swingHigh = ta.highest(high, swingLen); swingLow = ta.lowest(low, swingLen).

Объёмный импульс:

volZ = (volume - ta.sma(volume, volLen)) / ta.stdev(volume, volLen);

флаг volSpike = volZ >= volZThreshold (напр. 2.0).

Псевдо-CVD (delta-volume proxy):

signedVol = volume * math.sign(close - close[1])

cvd = nz(cvd[1]) + signedVol

cvdSlope = ta.linreg(cvd, lrLen, 0) (используем знак/наклон как прокси агрессии).

Сжатие ленты EMA (ribbon compression):

ribbonSpan = math.max(ema5,ema9,ema13,ema21) - math.min(ema5,ema9,ema13,ema21)

ribbonTight = (ribbonSpan/atr(14)) <= ribbonTightThr.

4) События и логика
4.1. Предпамп-состояние (Watch)

Считаем скором (целое/вещественное) — сумма весов:

squeezeOn ⇒ +2

bbWidth низко: bbWidth < sma(bbWidth, lookbackBW)*bwCoef ⇒ +1

ribbonTight ⇒ +1

Цена близко к EMA200: abs(close - ema200) <= atr(14)*distTo200Thr ⇒ +1

slope200 >= slopeUpThr (слегка вверх) ⇒ +1

volSpike (без пробоя) ⇒ +1

cvdSlope положительный ⇒ +1

Порог WatchScore ≥ watchMinScore (по умолчанию 4) включает фон-подсветку и/или маркер.

4.2. Триггер импульса (Trigger)

Срабатывает при выходе из компрессии с силой:

Пробой по направлению вверх:

Закрытие текущей свечи выше swingHigh (по swingLen).

*Close − EMA200 ≥ atr(14)confirmDepthMin (по умолчанию 0.35 ATR).

*Дистанция до верхней ATR/BB-полосы ≥ atr(14)airMin (по умолчанию 0.35 ATR).

volSpike ИЛИ cvdSlope > 0.
→ Сигнал Trigger Long.

Пробой вниз — зеркально (для полноты, но можно отключать в настройках).

Доп. фильтр (опционально включаемый): запрет pre-touch — если low[1]/high[1] касался EMA200, а подтверждение неглубокое (< 0.3 ATR), триггер игнорировать.

4.3. Метки и тексты

Над/под баром рисуется метка “Watch S: <score>” или “Trigger L (S:<score>)”.

На правой панели — мини-табличка текущих условий (галочки).

4.4. Алёрты

alertcondition( isWatch, "Pump Watch", "WATCH: {{ticker}} TF={{interval}} S={{score}} | BW={{bbWidth}} | TTM={{squeezeOn}} | dist200={{distInATR}}" )

alertcondition( isTriggerLong, "Pump Trigger Long", "TRIGGER LONG: {{ticker}} TF={{interval}} S={{score}} | Close>EMA200 by {{depthATR}} ATR | VolZ={{volZ}}" )

alertcondition( isTriggerShort, "Pump Trigger Short", … ) (можно отключить).

5) Настройки (inputs)

Основные:

emaLen200 = 200

emaRibbonLens = 5,9,13,21 (фиксированные)

atrLen = 14, atrMult = 2.0 (для каналов)

bbLen = 20, bbMult = 2.0

kcLen = 20, kcMult = 1.5

volLen = 50, volZThreshold = 2.0

lrLen = 50 (для CVD-наклона)

swingLen = 20

Пороговые:

watchMinScore = 4

confirmDepthMin = 0.35 (в ATR)

airMin = 0.35 (в ATR, «зазор до внешней полосы»)

ribbonTightThr = 0.25 (в ATR)

distTo200Thr = 0.2 (в ATR)

slopeUpThr = 0.00…0.05 (нормированный на ATR; подберите)

Опции:

Включать/выключать шорты.

Включать фильтр pre-touch.

Стиль визуализации: цвета фона для Watch/Trigger, включение/выключение панельки.

Сессии/временные окна (например, отключать алерты в ночные часы).

6) Визуализация

overlay:

EMA200 (белая), EMA5 (красн.), EMA9 (оранж.), EMA13 (жёлт.), EMA21 (зел.).

ATR-каналы (тонкими линиями).

Фон: squeezeOn — точечная/лёгкая заливка; Watch — полупрозрачная; Trigger — короткая вертикальная подсветка на баре.

Панель (separate scale=false): компактный блок текста с текущими значениями: Score, Squeeze, BBWidth, Dist200(ATR), Air(ATR), VolZ, CVD↑/↓.

7) Вычислительные детали / аккуратности

Никаких циклов по большим массивам; всё — на сериях.

Без security_lower_tf по умолчанию (перегружает), но оставить флажок «использовать 5m для VolZ/CVD» — если включено, брать request.security(syminfo.tickerid, "5", …).

Защитить деление на ноль, nz() везде.

Контролировать barstate.islast для тяжёлых отображений (экономить метки).

8) Выходные серии (для бэктеста/экспорта)

scoreSeries (float 0..10)

isWatch (bool)

isTriggerLong, isTriggerShort (bool)

Диагностические: bbWidth, distTo200ATR, airToBandATR, volZ, cvdSlope.

9) Приёмочные критерии (DoD)

Индикатор компилируется на Pine v5 без ошибок/варнингов.

На тикерах из примеров (BLESSUSDT.P, XNYUSDT.P, TAUSDT.P, COAIUSDT.P, DEGOUSDT.P, ТФ 15m):

Перед видимым импульсом минимум 1–3 бара подряд горит Watch (если была компрессия).

На первом уверенном пробое (закрытие ≥ 0.35 ATR над EMA200 и выше swingHigh) с объёмным всплеском — срабатывает Trigger Long.

Алерты создаются и уходят (проверить через «Тестер алертов»).

Включение/выключение фильтра pre-touch реально меняет количество ложных триггеров на боковых участках.

Переключение ТФ корректно пересчитывает все условия.

10) Расширение (Phase 2, опционально — отдельная задача)

Пара ввода символа спота (например, BINANCE:TAUSDT) и расчёт «лидирующего» спот-импульса (сравнение 5m-возврата спота и перпа).

Поле ввода символа Open Interest/Funding (если в TV есть поставщик таких серий) + добавление в скоринг: OI↑ и funding≤0 ⇒ +2.

Вне TV: вынести OI/funding/depth/social в ваш бот и подавать в TV через кастомные тикеры/символы (отдельный проект).