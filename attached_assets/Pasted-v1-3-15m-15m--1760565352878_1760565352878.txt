v1.3. Детектор пампа/дампа (15m). Условия без кода
Общее

Таймфрейм базовый: 15m.

Все проверки — по закрытию свечи.

Подсветка делается по направлению (Long/Short).

Вводим 2 пути:
A) «Компрессия → Выход» (для аккуратных сетапов),
B) «Взрыв из холодного старта (FIT)» — ловит резкий старт без предварительного Watch.

A) Путь «Компрессия → Выход»
A1. Watch Long (заряд вверх) — выполнить ВСЁ

Компрессия (2 из 3):

SqueezeOn (BB внутри KC),

BBWidth Z ≤ -0.8,

ATR% Z ≤ -0.5.
Требуем как минимум 2 признака из 3.

Персистентность компрессии:
Условия п.1 выполнялись ≥3 из последних 6 баров.

Катушка у средней:

RibbonTight = (max(EMA5..21) – min(EMA5..21)) / ATR ≤ 0.22,

Dist200ATR = |Close – EMA200| / ATR ≤ 0.25.

Направление:

Close ≥ EMA200,

slope200 = (EMA200−EMA200[1])/ATR ≥ -0.01 (т.е. плоская или чуть вверх).
(Раньше требовали ≥ +0.02 — это и «глушило» реальные старты; теперь допускаем почти плоскую 200-ю.)

Сухой объём:
Volume / SMA(50) < 0.8.

→ Все пп.2–5 + п.1(2/3) истинны → Watch Long.

Watch Short — всё зеркально (Close ≤ EMA200; slope200 ≤ +0.01; «воздух» и расстояния — те же).

Дебаунс/кулдаун для Watch

Показывать Watch, только если условия удержались минимум 2 подряд бара.

После Trigger (любого) — кулдаун 25 баров (Watch не рисуем).

A2. Trigger Long (выход из компрессии) — выполнить ВСЁ

Пробой диапазона: Close > SwingHigh(20).

Глубина закрепления над EMA200: (Close − EMA200)/ATR ≥ 0.30.

Воздух до верхней полосы: (BBupper − Close)/ATR ≥ 0.30.

Импульс объёма: VolZ ≥ 2.0.

Фильтр pre-touch: если предыдущая свеча трогала EMA200 и п.2 < 0.25, триггер не засчитывать.

→ Все 1–5 истинны → Trigger Long.
(Short — зеркально: пробой SwingLow(20), глубина под EMA200 ≥0.30 ATR, «воздух» до нижней полосы ≥0.30 ATR, VolZ≥2.0, pre-touch фильтр аналогично.)

Примечание: в «компрессионном» пути мы слегка ослабили пороги (0.35→0.30), чтобы не пропускать легитимные старты при плоской 200-й.

B) Путь FIT — First-Impulse Trigger (взрыв без предварительного Watch)

Срабатывает, даже если Watch не был. Нужен для ситуаций, как на вашем скрине: несколько часов «тишины» и резкий выстрел.

FIT Long — выполнить ВСЁ

Аномальный диапазон свечи:

TrueRange / ATR(14) ≥ 1.8 ИЛИ |Close − Open| / ATR ≥ 1.2.
(Сильное расширение диапазона/тела.)

Аномальный объём:

VolZ ≥ 3.0 ИЛИ объём ≥ 95-го перцентиля за 90 дней.

Структурный сдвиг вверх (любое из):

Close пересёк EMA200 снизу вверх и (Close − EMA200)/ATR ≥ 0.25,
ИЛИ

Close > SwingHigh(20).

Расширение волатильности:

BBWidth_now / BBWidth_avg(посл.5 баров) ≥ 1.8.
(Должен быть «взрыв» полос, а не просто большой бар в уже широком рынке.)

Не в потолок:

«Воздух» до верхней полосы: (BBupper − Close)/ATR ≥ 0.20.
(Для FIT порог мягче, чем в A2, чтобы не опоздать на старт.)

Pre-touch-фильтр (мягкий):

Если был pre-touch на предыдущем баре, требовать п.3 с глубиной (Close−EMA200)/ATR ≥ 0.30.

→ Все 1–5 (и 6 при необходимости) истинны → FIT Trigger Long.
(Short — зеркально: TR/ATR ≥1.8 или тело/ATR ≥1.2; VolZ≥3.0; пересечение EMA200 сверху вниз или пробой SwingLow(20); BBWidth_now / avg5 ≥ 1.8; «воздух» до нижней полосы ≥0.20.)

Кулдаун после FIT: 40 баров (чтобы не стрелял на каждом добое каскада).

C) Где не рисуем сигналы (оба пути)

Если |Close − EMA200|/ATR > 1.1 на момент сигнала — уже «слишком далеко» от средней → игнор.

Если «воздух» до соответствующей внешней полосы < 0.20 ATR (для A2 — <0.30, для FIT — <0.20) → игнор.

Повторный Trigger (любого типа) раньше кулдауна — игнор.

D) Что отдать на панель/в логи (для проверки)

Флаги: isWatchLong/Short, isTriggerLong/Short (A2), isFITLong/Short (B).

Диагностика: BBWidth Z, ATR% Z, RibbonTight (ATR), Dist200ATR, Air(ATR), slope200, VolZ, TR/ATR, BBWidth_now/avg5.

Таймстемпы и тип сработки: WATCH, TRIGGER, FIT.

Ещё два практичных тумблера

HTF-bias (опционально): разрешать Long-сигналы только если на 1H Close ≥ EMA200(1H) (и наоборот для Short). Включаем как фильтр, если шум вернётся.

Regime-filter: отключать всё, если ATR% Z ≥ +1.0 (рынок уже «широкий», взрывы там не информативны).