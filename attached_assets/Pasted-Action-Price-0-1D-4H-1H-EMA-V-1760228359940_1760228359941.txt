Action Price — спецификация
0) Таймфреймы и события

Контекст: 1D

Структура/Фильтры: 4H и 1H (EMA/VWAP)

Исполнение (где ищем паттерн и генерим сигнал): 15m и/или 1H

Точки запуска логики: на закрытии новой свечи 15m и 1H (в обе стороны).

1) Подготовка данных (precompute)

На старте дня и далее по расписанию:

Подтянуть OHLCV из БД для 1D/4H/1H/15m за lookback=90д.

Посчитать:

EMA50/EMA200 на 4H и 1H.

mTR(n=20) = median(high−low) последних 20 свечей на каждом ТФ (используем как ATR-замену для буферов/ширины зон).

VWAP (дневной) и, если включено, Anchored-VWAP (якорь — последний значимый swing на 1H/4H, см. ниже).

2) Зоны S/R (поддержка/сопротивление)
2.1 Построение “базовых” зон на 1D

Найти свинг-экстремумы (fractal k=2: High[k] — локальный максимум / Low[k] — локальный минимум).

Выделить базы консолидаций перед сильными импульсами: если за базой 3 подряд свечи дают суммарный ход ≥ 2× mTR(1D) — пометить high/low базы как зону.

Ширина зоны: zone_width = max(0.5×mTR(1D), 0.15% от цены); границы = [low−buffer, high+buffer] для demand/supply соответственно.

Слить пересекающиеся зоны (если центры ближе, чем 0.75×mTR(1D)).

2.2 Уточнение зон на 4H

На 4H посчитать количество касаний/реакций (хвосты/фиксация тел) внутри 1D-зоны.

Смарт-подстройка: расширить границы так, чтобы поймать максимум реакций на 4H, но final_width ≤ 1.25× (0.5×mTR(1D)).

Скоринг зоны score = 2×touches_recent(60д) + 1×touches_old + 1×impulse_strength − age_penalty. Оставить топ-N ближних к текущей цене (обычно 3–6).

Зоны пересчитывать разово в начале дня и слегка обновлять на закрытии 4H.

3) Тренд-фильтр и конфлюэнсы
3.1 Тренд по EMA (строгий, по умолчанию)

Long разрешён, если:
close(H4) > EMA200(H4) и EMA50(H1) > EMA200(H1).

Short разрешён, если:
close(H4) < EMA200(H4) и EMA50(H1) < EMA200(H1).

Если H4 и H1 конфликтуют → нет сделки (или снизить приоритет, если включён “aggressive_mode”).

3.2 Конфлюэнсы (не обязательны, но повышают “confidence”)

Цена касается/находится в пределах 0.5×mTR(1H) от дневного VWAP или Anchored-VWAP (якорь — последний swing на 1H: локальный экстремум с k=3, откуда пошёл импульс ≥ 1.5×mTR(1H)).

Наличие старшей зоны 1D/4H и “рабочей” подзоны на 1H (кластеры хвостов/тел).

4) Паттерны (детерминированные правила)

Пусть C0 — последняя закрытая свеча на ТФ исполнения (15m или 1H), C−1 — предыдущая, и т.д.
Везде использовать eps = 0.0001 × price для сравнения границ.

4.1 Pin-Bar

Для бычьего pin:
lower_wick = min(open,close) − low
upper_wick = high − max(open,close)
body = |close−open|, range = high−low
Условия:
lower_wick ≥ 2×body и lower_wick ≥ 0.6×range и upper_wick ≤ 0.25×range и close ≥ (low + 0.6×range)
(для медвежьего — зеркально).

В зоне: midpoint свечи попадает внутрь границ зоны S/R.

4.2 Outside-Bar / Engulfing (Поглощение)

Медвежий: high(C0) ≥ high(C−1)−eps и low(C0) ≤ low(C−1)+eps и close(C0) < open(C0) и |body(C0)| ≥ 0.8×|body(C−1)|.

Бычий: зеркально.

4.3 Inside-Bar (Внутренний бар)

high(C0) ≤ high(C−1)+eps и low(C0) ≥ low(C−1)−eps.

Торговать пробой “материнской” C−1 (см. триггеры).

4.4 Fakey (ложный пробой inside-bar)

Последовательность: C−2 — mother, C−1 — inside.

C0 делает пробой high/low C−2 по тикам (high>high_mother или low<low_mother), но закрывается обратно внутри диапазона C−2.

Направление входа — в сторону возврата.

4.5 ППР (двухсвечный разворот)

Медвежий: close(C0) < low(C−1)−eps.

Бычий: close(C0) > high(C−1)+eps.

5) Триггеры входа, стопы, цели
5.1 Предусловия (общие)

Цена внутри рабочей зоны S/R (1D/4H уточнённая на 1H).

Разрешение тренд-фильтра EMA (п.3.1).

Опционально: конфлюэнс VWAP/A-VWAP в пределах 0.5×mTR(1H).

5.2 Триггеры (по закрытию бара исполнения)

Pin-Bar: вход по пробою носа (buy stop над high для бычьего / sell stop под low для медвежьего) на следующей свече.

Engulfing: вход по пробою экстремума поглощающей свечи.

Inside-Bar: вход по пробою mother-bar в сторону тренда; если сработал ложный пробой → см. Fakey.

Fakey: вход в сторону возврата (через стоп-ордер над/под телом C0).

ППР: вход по рынку на открытии следующей свечи либо по стоп-ордеру за закрытием C0 (в сторону разворота).

5.3 Стоп-лосс (SL) и буфер

Pin-Bar: за хвостом pin + buffer,

Engulfing: за противоположным экстремумом C0 + buffer,

Inside-Bar: за противоположной стороной mother-bar + buffer,

Fakey: за экстремумом ложного пробоя + buffer,

ППР: за экстремумом C0 + buffer.
Где buffer = max(0.25×mTR(execTF), 0.05% от цены).

5.4 Тейк-профит (TP) и управление

TP1 = 1.5R, TP2 = 2.5R или ближайшая противоположная зона (что ближе).

Частичная фиксация: 50% на TP1, 50% на TP2.

Перенос в BE после достижения 1R.

Фильтр ликвидности/ширины: если расстояние до ближайшей противоположной зоны < 1.2R, сигнал не отправлять.

6) Анти-дубликаты и валидность зон

Один уникальный сигнал на (symbol, direction, zone_id, pattern, TF) в течение X часов (cooldown_hours по умолчанию 6ч для 1H, 2ч для 15m).

Зона теряет приоритет, если цена закрепилась за ней (3 подряд закрытия за границей) — пометить как сломанная до следующего дневного пересчёта.