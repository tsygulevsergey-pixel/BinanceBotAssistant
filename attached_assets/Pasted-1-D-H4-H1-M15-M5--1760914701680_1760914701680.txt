1) Принципы «как трейдер»

Сверху вниз: D → H4 → H1 → M15/M5. Старший ТФ задаёт контекст, младший — точность входа.

Зона, не цена: ширина = функция волатильности (ATR).

Сила уровня = касания × реакция × свежесть × конфлюэнс − шум.

Flip: чистый пробой телом + закрепление → R⇄S.

Меньше — лучше: близкие зоны сливаем; старшие всегда доминируют.

2) Пайплайн (продакшн-готовый)
A. Предобработка по каждому ТФ

Рассчитать: ATR(14), EMA200, (опц.) VWAP/POC, волатильностный режим (низк/средн/высок).

Найти свинги (фракталы): локальные High/Low с k по сторонам.
Рекоменд. k: D=3–5, H4=3–4, H1=3, M15=2–3.
Адаптируй k ↑ при высокой волатильности.

B. Кандидаты зон

Свинги: каждая вершина/дно → точечный кандидат.

Плотность цен: собери все High/Low/Close за окно (D/H4: 90–180д; H1: 30–90д; M15: 15–45д). Построй KDE/гистограмму по цене → пики = центры зон.

Круглые уровни: 100/250/500/1000-тиковая сетка для крипто; малый базовый вес.

Объём (если есть): Value Area High/Low, POC, пересечения с VWAP.

C. Зоны из кандидатов

Объедини ценовые точки кластеризатором по одной оси (цена): DBSCAN/MeanShift.
Порог ε (радиус) ≈ 0.4–0.8 * ATR_TF.

Для кластера Z:

mid = медиана цен в кластере;

width = clamp(c_low*ATR_TF, min_w, c_high*ATR_TF).
Рекоменд.: D: 0.6–1.6 ATR; H1: 0.4–1.0; M15: 0.3–0.7; min_w = 0.1% цены.

D. Сила зоны (0–100)
score = w1*Touches + w2*Reactions + w3*Freshness + w4*Confluence - w5*Noise


Рекоменд. веса: w1=24, w2=28, w3=18, w4=22, w5=12 (потом автотюнинг).

Touches: количество валидных касаний за окно. Валидное: бар зашёл в зону и в ближайшие m баров дал движение ≥ r1*ATR_mtf или p1%.
Реком.: m=6(H1)/12(M15), r1=0.6–1.0, p1=0.4–0.8% (MTF-зависимо).

Reactions: медиана/макс отката в ATR после касаний (больше — сильнее).

Freshness: эксп. затухание по последней реакции: exp(-Δt/τ).
τ: D=20д, H4=10д, H1=5д, M15=2д (по торговым сессиям).

Confluence: +EMA200 близко к краю зоны; +пересечение старшей зоны; +VWAP/POC; +round number.

Noise (clarity penalty): частые закрытия внутри зоны без отката; множественные «пилы» → штраф.

Классы силы: 80+ «ключевая», 60–79 «сильная», 40–59 «рабочая», <40 «слабая».

E. Тип зоны и flip

Тип S/R по последней значимой реакции: вверх = S, вниз = R.

Пробой телом: Close выходит за границу > b1*ATR_mtf (реком. b1=0.2–0.35) и закрепление:

Вариант 1: N баров подряд закрываются за зоной (N=2–3).

Вариант 2: ретест с обратной стороны + мини-реакция ≥ r2*ATR (r2=0.4–0.8).
→ Меняем тип (R→S или S→R), state="flipped", часть старого веса гасим (например, ×0.6).

F. Мульти-ТФ слияние

Строим D → H4 → H1 → M15/M5.

Если зона младшего ТФ пересекает старшую более чем на x% ширины (реком. x=35–50%), сливай их:

Границы = объединение (с приоритетом ширины старшей),

score += +confluence_bonus, подними класс.

G. Обновление по новой свече

Проверить новые свинги (с задержкой k).

Обновить касания/реакции/свежесть, пересчитать score.

Проверить условия пробоя/закрепления (flip/weakening).

Удалять/ослаблять «мертвые» зоны: нет касаний T (D: 60д; H1: 15д; M15: 5д).

3) Выходной формат (для твоего бота)
{
  "symbol": "BTCUSDT",
  "as_of": "2025-10-20T09:00:00Z",
  "zones": [
    {
      "tf": "H1",
      "kind": "R",               // или "S"
      "low": 64450.0,
      "high": 64880.0,
      "mid": 64680.0,
      "width_atr": 0.75,
      "strength": 82.4,          // 0..100
      "class": "key",            // key/strong/normal/weak
      "touches": 7,
      "last_touch_ts": "2025-10-20T07:00:00Z",
      "last_reaction_atr": 1.1,
      "freshness": 0.86,         // exp(-Δt/τ)
      "confluence": ["D overlap","EMA200","Round"],
      "state": "normal",         // normal/weakening/flipped
      "flip_side": null,         // "S" если flipped
      "history": [
        {"event":"touch","ts":"...","reaction_atr":0.9},
        {"event":"body_break","ts":"..."},
        {"event":"flip_to_support","ts":"..."}
      ]
    }
  ]
}

4) «Человеческие» правила применения

Контекст: не лонгуем в «ключевое R» на D/H4; не шортим в «ключевую S».

Триггеры входа у края зоны (на M15/M5): пин-бар/поглощение/CHoCH, возврат над/под край, микро-BOS; (опц.) отбой от VWAP/EMA200.

SL/TP: SL за противоположной границей зоны + буфер 0.2–0.4 ATR_mtf. TP1 = ближайшая локальная зона, TP2 = следующая старшая; после TP1 → BE/трейлинг.

5) Дефолт-параметры (с которых стартовать)

Фракталы k: D=4, H4=3, H1=3, M15=2.

Кластеризация: DBSCAN ε = 0.6*ATR_TF, min_samples=2.

Ширина зон: D=0.8–1.6 ATR; H1=0.5–1.0; M15=0.35–0.7 (clamp по min_w=0.1%).

Валидная реакция: ≥0.7*ATR_mtf в m=8 баров (H1), m=12 (M15).

Пробой телом: b1=0.3*ATR_mtf, закрепление N=2.

Свежесть τ: D=20д, H4=10д, H1=5д, M15=2д.

Merge порог: пересечение ≥40% ширины.

Сила: пороги классов 40/60/80.

6) Валидация и автотюнинг (обязательно)

Метрики по истории:

Hit-rate реакции: доля касаний → откат ≥ r1*ATR в m баров.

Средний/медианный откат (в ATR) и время до реакции.

Ложные пробои на 100 касаний.

Стабильность во времени: разбить по режимам волатильности/сессиям.
Автотюнинг: Bayesian/optuna по k, ε, r1, b1, τ, w1..w5, целевая функция = max(score stability & reaction rate) при контроле количества зон (не > N на ТФ).

7) Интеграция в твой бот

По расписанию (или при новом баре) для каждого ТФ: построить/обновить зоны.

Сохранить JSON в кэш/БД; хранить историю событий зоны.

В сигнальном модуле использовать:

фильтры по классу/силе зоны в контексте старших ТФ,

триггеры входа (паттерн/микро-структура),

SL/TP от границ зоны.

Логи: каждое касание/реакцию писать в таблицу — это база для обучения.

8) Анти-ловушки

Не плодить уровни: обязательный merge близких кластеров.

Игнорировать «внутризонные» закрытия без реакции — это шум.

На тренде расширять ширину (высокая вола), во флэте сужать.

Старшие зоны рисуем толще, младшие — тоньше/полупрозрачно.