0) Цель патча

Увеличить число валидных сигналов.

Сократить стоп-дистанцию и тейки под скальп-режим (малые движения).

Исключить ситуации, когда отсутствие внешних рядов (OI/CVD/Funding) полностью блокирует входы.

1) Профили чувствительности (для быстрого старта)

Сделать переключатель профиля: Starter / Balanced / Strict.
По умолчанию — Starter (чтобы сигналы точно появились).

Starter (рекомендуем для начала)

Фильтр жирных свечей: порог 1.35×ATR(14).

Retest: включён; база ретеста — Donchian; допуск — 12 тиков; срок годности — 8 баров.

Squeeze как обязательное условие: выключен (считается бонусом к score).

Скоринг: score_min = 1.

Фильтры CVD/OI/Funding: выключены (или «мягкие», см. §4).

Избегать времени funding: выключено.

Кламп стопа: sl_min = 0.08%, sl_max = 0.45%.

Тейки: TP0=0.5R (33%), TP1=1.0R (33%), TP2=1.5R (34%); после TP0 — SL→BE; после TP1 — трейлинг по ATR(7) × 1.0.

Balanced

Порог жирной свечи 1.25×ATR; Retest тот же, допуск 10 тиков, срок 6 баров.

score_min = 2; включить Squeeze как плюс к score, не как обязательное.

Включить «мягкий» OI и CVD (см. §4).

Избегать funding ±10 мин.

Кламп стопа: 0.10% … 0.50%.

Strict

Порог жирной свечи 1.15×ATR; Retest допуск 6–8 тиков, срок 4–6 баров.

score_min = 3; включить все деривативные фильтры.

Избегать funding ±15 мин.

Кламп стопа: 0.12% … 0.60%.

2) Порядок проверки условий (важно для появления сигналов)

Контекст тренда

Лонг: цена выше EMA200; Шорт: ниже EMA200.

Дополнительно (но не обязательно): EMA20 над EMA50 в лонге / наоборот в шорте.

Сетап (любое из двух достаточно)

Пробой Donchian (закрытие выше/ниже предыдущей границы).

Выход из squeeze за пределы полос Боллинджера.

В профилях Starter/Balanced squeeze не обязателен.

Fat-bar фильтр

Ограничивает только мгновенный вход по закрытию.

Не запрещает «вооружить» сигнал для ретеста.

Retest-логика (по умолчанию включена)

После сетапа сигнал армируется.

База зоны ретеста: Donchian-граница (по умолчанию) / BB-mid / VWAP / зона EMA20-50.

Вход разрешён, когда экстремумы свечи касаются зоны с допуском в тиках.

Срок годности — N баров; по истечении — сигнал аннулируется.

На дешёвых альтах (мелкий tickSize) — держать допуск 15–20 тиков; на мейджорах — 8–12.

Альтернатива: допуск как доля ATR (например, 0.10–0.15×ATR).

Стоп-логика (микро-структура + кламп)

Кандидаты для SL (лонг):
a) за ближайшим свинг-минимумом последних 3 баров;
b) за телом сигнальной свечи (не за тенью);
c) чуть ниже опорной зоны (EMA20/VWAP/Keltner-basis) на 0.3–0.5×ATR;
d) по «быстрому ATR» (ATR(7) × 0.6).

Выбираем наибольшую из этих опор (чтобы SL не оказался слишком близко).

Затем применяем CLAMP по проценту от входа:

Если дистанция > sl_max ⇒ сделку не брать (или ждать ретеста);

Если < sl_min ⇒ поднять SL до минимума (sl_min).

Для шорта — всё зеркально.

Тейки и ведение

TP0=0.5R (33%) → сразу BE.

TP1=1.0R (ещё 33%).

TP2=1.5R (остаток) + трейлинг по ATR(7)×1.0.

max_bars_in_trade = 12–24 (12 — более скальпово).

Скоринг

Каждое из условий даёт баллы: тренд, retest-hit, don-break, squeeze-exit, «не fat-bar», и т.д.

Значение score_min зависит от профиля (см. выше).

В профиле Starter держать score_min = 1.

3) «Мягкие» деривативные фильтры (чтобы не блокировали сигналы)

Если ряд недоступен (внешний тикер не найден/n/a), фильтр не участвует в блокировке (нейтраль).

Если ряд доступен:

CVD: требуется знак в сторону входа на сигнальном баре (или нейтраль).

ΔOI: положительный в сторону входа и по модулю ≥ X% своей медианы (X = 3–10%, подбирается).

Funding: абсолютное значение ниже порога fund_abs_max; в противном случае — минус к score, а не полный запрет.

«Избегать funding-времени» — опционально; по умолчанию выкл.

4) Диагностика «почему нет входа» (на панели)

Показывать два коротких статуса одновременно — для лонга и для шорта:

NO SETUP — не выполнен пробой/выход.

ARMED — сигнал активирован, ждём ретеста (показывать базовый уровень и сколько баров осталось до истечения).

HIT — ретест был, вход подтверждён.

FAT BAR — мгновенный вход запрещён из-за слишком «жирного» бара.

FILTERS — блокировка деривативными фильтрами.

SL TOO FAR — стоп > sl_max.

SL TOO SMALL — стоп < sl_min.

SCORE LOW — score ниже порога.

NEAR FUNDING — блокировано таймингом funding (если включено).

На панели ещё вывести: текущее ATR(7), рассчитанный Stop %, выбранную базу ретеста, допуск в тиках и оставшиеся бары до истечения.

5) Подсказки по калибровке под альты

Жирные свечи: на «тонких» альтах начните с 1.45–1.55×ATR, на ликвидных — 1.25–1.35×ATR.

Retest-допуск:

цена < 0.05 USDT ⇒ 15–25 тиков;

0.05–1 USDT ⇒ 10–15 тиков;

1 USDT ⇒ 8–12 тиков.
Или используйте допуск как 10–15% от ATR(14).

SL-кламп:

для «пенни-альтов» держите 0.10–0.60%;

для мейджоров можно ужать до 0.06–0.40%.

Если сигналов всё равно мало:

временно отключите squeeze как обязательный;

поставьте score_min = 0–1;

расширьте retest_expire до 10 баров;

немного увеличьте допуск ретеста;

убедитесь, что уровень ретеста выбран правильно (Donchian часто даёт более частые касания, чем BB-mid).

6) Приёмочные критерии (что проверить на графике)

Сигналы появляются: стрелка и уровни Entry/SL/TP0/TP1/TP2 показаны на свече ретеста (а не на «жирном» импульсе).

Fat-bar не блокирует «армирование» сигнала — виден статус ARMED и пунктир уровня ретеста.

SL в процентах укладывается в кламп; при превышении — статусы SL TOO FAR/SL TOO SMALL.

После TP0 — SL → BE; после TP1 — включается трейлинг (линия SL двигается).

Панель «Debug» показывает причину отсутствия входа, если он не произошёл.

На 2–3 тестовых парах (например, ETHUSDT, SCRUSDT, JOEUSDT) за последние 2 недели должно быть ощутимое количество сделок (не «ноль»), при Starter профиле.

7) Короткий чек-лист для тебя

Включи профиль Starter и пробеги по 3–5 альтам.

Если сигналов мало — увеличь допуск ретеста на +3–5 тиков и срок на +2 бара.

Если стопы всё ещё велики — увеличь долю «зонного» компонента (ближе к EMA20/VWAP) и чуть снизь sl_max.

Если слишком много «грязных» входов — снова включи squeeze как плюс к score или подними score_min до 2.